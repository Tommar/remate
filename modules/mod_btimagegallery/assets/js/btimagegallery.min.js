var BT=BT||{};
(function(){
    BT.ImageGallery=new Class({
        Implements:[Options,Events],
        options:{},
        initialize:function(b){
            this.setOptions(b);
            var a=JSON.decode(new BT.Base64().base64Decode(this.options.encodedItems));
            var c=this;
            this.sortables=new Sortables(this.options.galleryContainer,{
                clone:true,
                revert:true,
                opacity:0.3,
                onStart:function(e,f){
                    f.setStyle("z-index",999)
                }
            });
            if(a!=null){
                a.each(function(e){
                    c.add(e)
                })
            }
            var d=null;
            if(typeof document.adminForm.onsubmit=="function"){
                d=document.adminForm.onsubmit
            }
			
            document.adminForm.onsubmit=function(){
                var e=[];
                var f=0;
                $$("#btig-gallery-container li").each(function(g){
					var h = g.retrieve('item');
                    if(h!=null){
                        e[f]=h;
                        f++
                    }
                });
                $("btig-gallery-hidden").set("value",new BT.Base64().base64Encode(JSON.encode(e)));
                if(d!=null){
                    d()
                }
            }
        },
        add:function(d, tmp){
		
            var videoicon = '<div class="videoIcon"></div>';
            var b=new Element("li",{
                 html:(d.youid ? videoicon :'')+ '<img src="'+this.options.liveUrl+"modules/mod_btimagegallery/images" + (tmp ? "/tmp" : "") + "/manager/"+d.file+'" /><a href="javascript:void(0)" class="edit">Edit</a><a href="javascript:void(0)" class="remove">Remove</a>'
            });
			if(d.remote){
				b.set("title", d.remote);
				b.setStyle('background-color','#E6E6FA');
			}
			
            var c=this;
            b.getElement(".edit").addEvent("click",function(){
                c.edit(b)
            });
            b.getElement(".remove").addEvent("click",function(){
                c.remove(b)
            });
            b.store("item",d);
            var a=$(this.options.galleryContainer);
            b.set("opacity",0);
            a.grab(b);
            b.fade("in");
            this.sortables.addItems(b)
        },
        edit:function(b){
		
            var a=new Element("div#btig-dialog",{
                html:this.options.dialogTemplate
            });
            var c=b.retrieve("item");
			console.log(c);
            a.getElement(".btig-title").set("value",c.title);
            a.getElement(".btig-alt").set("value",c.alt);
            a.getElement(".btig-youid").set("value",c.youid);
			a.getElement(".btig-autoplay").set("value", c.autoplay);	
            a.getElement(".btig-dialog-ok").addEvent("click",function(){
                c.title=a.getElement(".btig-title").get("value");
                c.youid=a.getElement(".btig-youid").get("value");
                c.autoplay =a.getElement(".btig-autoplay").get("value");
				c.alt = a.getElement(".btig-alt").get("value");
                b.store("item",c);
                SqueezeBox.close()
            });
            a.getElement(".btig-dialog-cancel").addEvent("click",function(){
                SqueezeBox.close()
            });
            SqueezeBox.open(a,{
                handler:"adopt",
                size:{
                    x:580,
                    y:180
                }
            })
        },
        remove:function(a){
    
            var img = a.getElement('img').src.split('/');
			var file = img[img.length - 1];
            var c = this;
            jQuery.ajax({
                url: location.href,
                data: "action=delete&id="+ this.options.moduleID + "&file="+file,
                type: "post",
                dataType:"json",
                success:function(data){
                    if(!data.success){
                        c.showMessage("btig-message","<b>Failed to delete images </b> - "+data.message)
                    }else{
                        var b=new Fx.Morph(a);
                        b.start({
                            width:0,
                            height:0,
                            opacity:0
                        }).chain(function(){
                            a.dispose()
                        });
                        c.showMessage("btig-message","<b>Deleted images successfully</b>")
                    }
                },
                complete:function(){
                    c.removeLog()
                },
                error: function(jqXHR, textStatus, errorThrown){
                    c.showMessage("btig-message", "Sending ajax request is failed. Check <b>ajax.php</b>, please.");
                    c.removeLog();
                }
            })
        },
        removeAll:function(){
            var a = $("btig-gallery-container");
            var b = a.getElements("li");
            var c = this;
            var success = true;
            b.each(function(d){
               var img = d.getElement('img').src;
                jQuery.ajax({
                    url: location.href,
                    data: "action=delete&id="+ c.options.moduleID + "&file="+ img,
                    type: "post",
					dataType: "json",
                    success: function(data){
                        if (!data.success) {
                            success = false;
                        }
                        else {
                            var f=new Fx.Morph(d);
                            f.start({
                                width:0,
                                height:0,
                                opacity:0
                            }).chain(function(){
                                d.dispose()
                            });
                            success = true;
                        }
                    },
                    complete: function(){
                        c.removeLog();
                    },
                    error: function(jqXHR, textStatus, errorThrown){
                        c.showMessage("btig-message", "Sending ajax request is failed. Check <b>ajax.php</b>, please.");
                        c.removeLog();
                    }
        
                })
               
            });
            if(!success){
                c.showMessage("btig-message", "<b>Failed to delete images </b> - " + data.message);
            }else{
                c.showMessage("btig-message", "<b>Deleted images successfully</b>");
            }
            c.removeLog();

            
        },
        showMessage:function(a,d){
            var a=$(a);
            var c=new Element("div.bt-message");
            c.set("html",d);
            c.set("opacity",0);
            a.grab(c,"top");
            var b=new Fx.Morph(c,{
                link:"chain"
            });
            b.start({
                opacity:1,
                visibility:'visible'
            })
        },
        removeLog:function(){
            $("btig-message").getElements("div.bt-message").each(function(d,b,c){
                setTimeout(function(){
                    var e=new Fx.Morph(d,{
                        link:"chain"
                    });
                    e.start({
                        height:0,
                        opacity:0
                    }).chain(function(){
                        d.dispose()
                    })
                },1000)
            })
        }
    })
})();